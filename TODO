FSV GTK3 Migration Plan
========================

Goal: Migrate from GTK+ 2.0 to GTK 3, with pragmatic middle-of-the-road
library choices. Each step should leave the code compilable and runnable.


PHASE 1: GTK 3 TRIVIAL RENAMES (mechanical changes, low risk)  *** DONE ***
==============================================================

Step 1.1 - Build system: switch to GTK 3 pkg-config
  [x] configure.ac: change gtk+-2.0 to gtk+-3.0 >= 3.16
  [x] README.md: update dependency list (libgtk-3-dev replaces libgtk2.0-dev,
      drop libgtkgl2.0-dev)
  [x] Verify ./autogen.sh && ./configure completes

Step 1.2 - Replace deprecated box/pane/separator/scrollbar constructors
  [x] gtk_hbox_new()        -> gtk_box_new(GTK_ORIENTATION_HORIZONTAL, ...)
  [x] gtk_vbox_new()        -> gtk_box_new(GTK_ORIENTATION_VERTICAL, ...)
  [x] gtk_hpaned_new()      -> gtk_paned_new(GTK_ORIENTATION_HORIZONTAL)
  [x] gtk_vpaned_new()      -> gtk_paned_new(GTK_ORIENTATION_VERTICAL)
  [x] gtk_hscrollbar_new()  -> gtk_scrollbar_new(GTK_ORIENTATION_HORIZONTAL, ...)
  [x] gtk_vscrollbar_new()  -> gtk_scrollbar_new(GTK_ORIENTATION_VERTICAL, ...)
  [x] gtk_hseparator_new()  -> gtk_separator_new(GTK_ORIENTATION_HORIZONTAL)
  [x] (Also fix the #if 0 block: gtk_hscale_new, gtk_vscale_new -> gtk_scale_new)

Step 1.3 - Replace GtkTable with GtkGrid
  [x] gui_table_add(): gtk_table_new() -> gtk_grid_new()
  [x] gui_table_attach(): gtk_table_attach() -> gtk_grid_attach()
  [x] Update cell_padding to use gtk_grid_set_row/column_spacing()

Step 1.4 - Replace deprecated GdkColor API with GdkRGBA
  [x] gui.c color_picker_cb(): GdkColor -> GdkRGBA,
      gtk_color_button_get_color() -> gtk_color_chooser_get_rgba()
  [x] gui.c gui_colorpicker_set_color(): same
  [x] gui.c colorsel_window_cb() and gui_colorsel_window():
      GtkColorSelectionDialog -> GtkColorChooserDialog
      gtk_color_selection_get_current_color() -> gtk_color_chooser_get_rgba()

Step 1.5 - Fix direct struct field access (removed in GTK 3)
  [x] GTK_ENTRY(entry_w)->text_length -> gtk_entry_get_text_length()
  [x] GTK_STATUSBAR(statusbar_w)->messages -> gtk_statusbar_get_context_id()
  [x] GTK_MENU(menu_w)->parent_menu_item -> gtk_menu_get_attach_widget()
  [x] GtkAdjustment direct field access -> getter/setter functions
      (camera.c: introduced AdjValues struct as intermediary)
  [x] GTK_CHECK_MENU_ITEM(menuitem)->active ->
      gtk_check_menu_item_get_active()  (callbacks.c)
  [x] togglebutton->active -> gtk_toggle_button_get_active()  (callbacks.c)

Step 1.6 - Replace other deprecated GTK 2 APIs
  [x] gdk_cursor_unref() -> g_object_unref()
  [x] gdk_screen_get_width()/gdk_screen_get_default() ->
      GdkDisplay + GdkMonitor + gdk_monitor_get_geometry()
  [x] GTK_STOCK_CANCEL / GTK_STOCK_OK -> "_Cancel" / "_OK" strings
  [x] gtk_menu_item_set_right_justified() -> gtk_widget_set_hexpand/halign
  [x] gtk_menu_popup() -> gtk_menu_popup_at_pointer()
  [x] gtk_entry_set_editable() -> gtk_editable_set_editable()
  [x] GtkStyle/gtk_widget_get_style() -> GtkStyleContext
  [x] gdk_window_set_back_pixmap() -> gdk_window_set_background_pattern()
  [x] gtk_widget_set_double_buffered() -> gtk_widget_set_app_paintable()
  [x] gtk_widget_set_events() left as-is (still works in GTK 3)
  [x] Build and verify compilation -- PASSES (deprecation warnings only)

  Remaining deprecation warnings (acceptable for Phase 1):
  - gdk_window_set_background_pattern (ogl.c) -- Phase 2 will remove
  - gdk_cairo_create (gui.c) -- Phase 2 will use "draw" signal
  - gtk_style_context_get_background_color (dialog.c) -- cosmetic


PHASE 2: OPENGL WIDGET MIGRATION (the big one)  *** DONE ***
===============================================

Step 2.1 - Replace expose-event with draw signal
  [x] gui.c preview_spectrum_expose_cb(): changed to "draw" signal
      with cairo_t *cr parameter, removed gdk_cairo_create()
  [x] ogl.c expose_cb(): replaced entirely by GtkGLArea "render" signal

Step 2.2 - Replace manual GLX with GtkGLArea
  [x] ogl.c: replaced GtkDrawingArea + manual GLX with GtkGLArea
  [x] Removed glXChooseVisual(), glXCreateContext(), glXMakeCurrent(),
      glXSwapBuffers() -- GtkGLArea handles all of this
  [x] Added create-context signal for compatibility profile
  [x] Replaced realize_cb, expose_cb, configure_cb with
      realize/render/resize GtkGLArea signals
  [x] Removed gdk_window_set_background_pattern() and
      gtk_widget_set_app_paintable() (not needed with GtkGLArea)
  [x] Removed gdk/gdkx.h, GL/glx.h includes (no X11 dependency)
  [x] Refactored geometry_highlight_node() to eliminate front-buffer
      access (draws highlight as part of normal render pass)
  [x] Removed re-render in ogl_color_pick() (no longer needed)
  [x] configure.ac: removed GL/GLX/X11 manual checks, uses epoxy only
  [x] src/Makefile.am: removed @GL_LIBS@, @X11_LIBS@, @GL_CFLAGS@,
      @X11_CFLAGS@; uses @EPOXY_CFLAGS@ and @EPOXY_LIBS@
  [x] animation.c: updated render loop to use ogl_queue_render()
  [x] viewport.c: removed GDK_EXPOSE/GDK_CONFIGURE event handling
  [x] gui.c: removed GDK_EXPOSURE_MASK/GDK_STRUCTURE_MASK from
      GL area event mask

Step 2.3 - Replace GLU usage
  [x] tmaptext.c: gluBuild2DMipmaps() -> glTexImage2D() +
      glGenerateMipmap()
  [x] configure.ac: removed GLU dependency check and -lGLU
  [x] Removed #include <GL/glu.h> from tmaptext.c and ogl.c
  [x] Fixed stray */ comment terminator bug in tmaptext.c

Step 2.4 - Replace GL/gl.h with epoxy/gl.h
  [x] All files including <GL/gl.h>: changed to <epoxy/gl.h>
      (ogl.c, geometry.c, tmaptext.c, about.c)
  [x] Removed <GL/glx.h> includes (replaced with epoxy, then removed)
  [x] Added PKG_CHECK_MODULES([EPOXY], [epoxy]) to configure.ac


PHASE 3: CLEANUP AND POLISH  *** DONE ***
============================

Step 3.1 - Skip (entry API)
  [x] gtk_entry_set_text() / gtk_entry_get_text() are NOT deprecated in GTK 3.
      The gtk_editable_* replacements are a GTK 4 concern.
      gtk_entry_select_region() already uses gtk_editable_select_region().

Step 3.2 - Remove -Wno-incompatible-pointer-types compiler flag
  [x] gui.h/gui.c: changed void (*callback)( ) to GCallback callback
      in all 13 gui_* function declarations/definitions
  [x] dialog.c, window.c, gui.c: wrapped ~47 callback arguments with
      G_CALLBACK() at call sites
  [x] gui.c: changed struct OptionMenuItem callback field to GCallback
  [x] scanfs.c: added explicit (union AnyNodeDesc *) casts for
      g_slice_new0() assignments
  [x] dialog.c: fixed g_list_insert_before() sibling argument using
      g_list_find() to get the GList node
  [x] src/Makefile.am: removed -Wno-incompatible-pointer-types

Step 3.3 - Update build documentation
  [x] README.md: noted GTK 3.16+ requirement, GL compatibility profile,
      GDK_BACKEND=x11 fallback for Wayland/Mesa issues

Step 3.4 - Clean up dead code
  [x] Deleted the entire #if 0 block in gui.c (gui_check_button_add,
      gui_check_menu_item_add, gui_entry_set_width, gui_spin_button_add,
      gui_string_width, gui_hscale_add, gui_vscale_add, gui_tooltip_add)
      -- all used removed GTK 1/2 APIs and were unreferenced

Step 3.5 - Final verification
  [x] Build with no warnings (beyond cosmetic
      gtk_style_context_get_background_color deprecation in dialog.c)
  [ ] Test all three visualization modes (DiscV, MapV, TreeV)
  [ ] Test directory tree expand/collapse
  [ ] Test file list population
  [ ] Test color mode switching
  [ ] Test About screen
  [ ] Test on Wayland session
  [ ] Test on X11 session


NOTES
=====
- Each step should leave the code compilable and runnable
- User tests after each phase completion
- The #if 0 block in gui.c (lines 1472-1605) contains unused code with
  additional deprecated APIs (GtkTooltips, gtk_check_menu_item_set_show_toggle).
  We can either port or delete it.
- geometry.c uses ~267 legacy GL calls (glBegin/glEnd, display lists, etc.)
  These work fine under GL compatibility profile and are NOT changed in this
  migration. A future project can move to modern GL core profile.
- The nvstore.c library is self-contained and needs no changes.
- The lib/getopt.c, lib/getopt1.c, lib/scandir.c, lib/fileblocks.c are
  POSIX polyfills and need no changes.
